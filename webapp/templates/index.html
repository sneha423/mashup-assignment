<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mashup Generator</title>
</head>
<body>
    <h1>Mashup Generator</h1>

    {% if error %}
        <p style="color:red">{{ error }}</p>
    {% endif %}
    {% if message %}
        <p style="color:green">{{ message }}</p>
    {% endif %}

    <form method="post" id="mashup-form">
        <label>Singer Name:</label><br>
        <input type="text" name="singer" required><br><br>

        <label>Number of Videos (&gt; 10):</label><br>
        <input type="number" name="num_videos" min="11" required><br><br>

        <label>Audio Duration in seconds (&gt; 20):</label><br>
        <input type="number" name="duration" min="21" required><br><br>

        <label>Email:</label><br>
        <input type="email" name="email" required><br><br>

        <button type="submit">Create Mashup</button>
    </form>

    <div id="progress-container" style="display:none; margin-top:20px;">
        <p id="progress-text">Starting...</p>
        <progress id="progress-bar" max="100" value="0" style="width:300px;"></progress>
    </div>

    <script>
window.onload = function () {
    const form = document.getElementById("mashup-form");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");

    form.addEventListener("submit", function (event) {
        event.preventDefault(); // stop normal form submit

        const formData = new FormData(form);

        // Show progress bar immediately
        progressContainer.style.display = "block";
        progressBar.value = 0;
        progressText.textContent = "Starting...";

        // Send POST via fetch
        fetch("/", {
            method: "POST",
            body: formData
        })
        .then(resp => resp.text()) // we don't use the HTML, just trigger the job
        .then(() => {
            // Start polling after server accepted the job
            startPolling();
        })
        .catch(err => {
            progressText.textContent = "Error starting mashup.";
            console.error(err);
        });
    });

    function startPolling() {
        const interval = setInterval(() => {
            fetch("/progress")
                .then(resp => resp.json())
                .then(data => {
                    progressBar.value = data.percent;
                    progressText.textContent = data.message || ("Progress: " + data.percent + "%");

                    if (data.error) {
                        clearInterval(interval);
                        progressText.textContent = "Error: " + data.error;
                    } else if (data.done && data.percent >= 100) {
                        clearInterval(interval);
                        progressText.textContent = "Done! Check your email.";
                    }
                })
                .catch(err => {
                    clearInterval(interval);
                    progressText.textContent = "Error getting progress.";
                    console.error(err);
                });
        }, 2000);
    }
};
</script>

</body>
</html>